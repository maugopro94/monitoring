<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Adhesion - Monitoring</title>
  <link href="https://fonts.googleapis.com/css2?family=Sora:wght@300;400;600;700&display=swap" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"/>
  <link rel="stylesheet" href="styles/app.css"/>
</head>
<body class="page-adhesion">
  <main class="container py-5">
    <div class="adhesion-top d-flex flex-wrap align-items-center justify-content-between gap-3 mb-4">
      <div>
        <span class="adhesion-kicker">Adhesion</span>
        <h1 class="adhesion-title">Devenir membre et acceder aux poles</h1>
        <p class="adhesion-subtitle">Inscription, validation du pole, puis paiement via Wave pour activer votre acces.</p>
      </div>
      <a class="adhesion-back" href="index.html">Retour a l accueil</a>
    </div>

    <section class="adhesion-hero">
      <div class="row g-4 align-items-center">
        <div class="col-lg-7">
          <div class="adhesion-steps">
            <div class="adhesion-step">
              <div class="step-index">1</div>
              <div>
                <h3>Inscription</h3>
                <p>Renseignez vos informations et choisissez votre pole d intervention.</p>
              </div>
            </div>
            <div class="adhesion-step">
              <div class="step-index">2</div>
              <div>
                <h3>Paiement Wave</h3>
                <p>Reglez le prix d adhesion pour activer l acces a la plateforme.</p>
              </div>
            </div>
            <div class="adhesion-step">
              <div class="step-index">3</div>
              <div>
                <h3>Activation</h3>
                <p>Votre compte est active et rattache a votre pole.</p>
              </div>
            </div>
          </div>
        </div>
        <div class="col-lg-5">
          <div class="price-card">
            <div class="price-header">
              <span class="price-label">Adhesion a vie</span>
              <span class="price-badge">Membre observateur</span>
            </div>
            <div class="price-amount" id="priceAmount">5000 XOF</div>
            <ul class="price-list">
              <li>Acces aux observations du pole</li>
              <li>Participation aux activites terrain</li>
              <li>Messagerie interne avec l equipe</li>
              <li>Rapports et exports filtres</li>
            </ul>
            <button class="wave-btn" type="button">Payer avec Wave</button>
            <p class="price-note">Etudiants: 5 000 XOF - Professionnels: 10 000 XOF.</p>
          </div>
        </div>
      </div>
    </section>

    <section class="adhesion-form card">
      <div class="card-body">
        <h2 class="section-title">Formulaire d inscription</h2>
        <p class="section-subtitle">Les champs marques * sont obligatoires.</p>
        <div class="alert alert-info mb-4" role="alert">
          L activation du compte est effectuee par le controleur de qualite du pole selectionne apres verification.
        </div>
        <form id="adhesionForm">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Prenom *</label>
              <input class="form-control" type="text" id="memberFirstName" placeholder="Prenom"/>
            </div>
            <div class="col-md-6">
              <label class="form-label">Nom *</label>
              <input class="form-control" type="text" id="memberLastName" placeholder="Nom"/>
            </div>
            <div class="col-md-6">
              <label class="form-label">Email *</label>
              <input class="form-control" type="email" id="memberEmail" placeholder="email@exemple.com"/>
            </div>
            <div class="col-md-6">
              <label class="form-label">Telephone *</label>
              <input class="form-control" type="tel" id="memberPhone" placeholder="77 000 00 00"/>
            </div>
            <div class="col-md-6">
              <label class="form-label">Mot de passe *</label>
              <input class="form-control" type="password" id="memberPassword" placeholder="Minimum 6 caracteres"/>
            </div>
            <div class="col-md-6">
              <label class="form-label">Confirmer le mot de passe *</label>
              <input class="form-control" type="password" id="memberPasswordConfirm" placeholder="Confirmer le mot de passe"/>
            </div>
            <div class="col-md-6">
              <label class="form-label">Fonction *</label>
              <input class="form-control" type="text" id="memberFunction" placeholder="Ex: Observateur terrain"/>
            </div>
            <div class="col-md-6">
              <label class="form-label">Organisation *</label>
              <input class="form-control" type="text" id="memberOrganization" placeholder="Ex: Institut / ONG / Projet"/>
            </div>
            <div class="col-md-6">
              <label class="form-label">Type d adhesion *</label>
              <select class="form-select" id="memberType">
                <option value="">Selectionner</option>
                <option value="student">Etudiant (5 000 XOF)</option>
                <option value="professional">Professionnel (10 000 XOF)</option>
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label">Pole *</label>
              <select class="form-select" id="adhesionPole">
                <option value="">Selectionner un pole</option>
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label">Profil *</label>
              <input class="form-control" type="text" value="Membre observateur" readonly/>
            </div>
          </div>
          <div class="d-flex flex-wrap gap-3 mt-4">
            <button class="btn btn-primary" type="button" id="btnSubmitAdhesion">Soumettre l inscription</button>
            <button class="btn btn-outline-secondary" type="reset">Reinitialiser</button>
          </div>
          <div class="mt-3 text-muted" id="adhesionStatus"></div>
        </form>
      </div>
    </section>

    <section class="adhesion-status row g-3">
      <div class="col-md-4">
        <div class="status-card">
          <span class="status-pill pending">En attente</span>
          <h3>Inscription recue</h3>
          <p>Votre dossier est en verification avant activation.</p>
        </div>
      </div>
      <div class="col-md-4">
        <div class="status-card">
          <span class="status-pill paid">Paiement confirme</span>
          <h3>Wave valide</h3>
          <p>Le paiement a ete enregistre et votre acces est en cours.</p>
        </div>
      </div>
      <div class="col-md-4">
        <div class="status-card">
          <span class="status-pill active">Acces actif</span>
          <h3>Compte actif</h3>
          <p>Vous pouvez acceder aux observations de votre pole.</p>
        </div>
      </div>
    </section>
  </main>
  <script>
    const priceMap = { student: 5000, professional: 10000 };
    const priceAmount = document.getElementById("priceAmount");
    const memberType = document.getElementById("memberType");

    function formatAmount(amount) {
      if (!amount) return "5 000 / 10 000 XOF";
      return amount.toLocaleString("fr-FR") + " XOF";
    }

    function updatePrice() {
      const value = memberType ? memberType.value : "";
      const amount = priceMap[value] || 0;
      if (priceAmount) priceAmount.textContent = formatAmount(amount);
    }

    async function loadPoles() {
      const select = document.getElementById("adhesionPole");
      if (!select) return;
      try {
        const res = await fetch("api.php?route=filters/zones");
        const data = await res.json();
        const items = data.items || [];
        select.innerHTML = "<option value=\"\">Selectionner un pole</option>";
        items.forEach((pole) => {
          const opt = document.createElement("option");
          opt.value = pole;
          opt.textContent = pole;
          select.appendChild(opt);
        });
      } catch (err) {
        // fallback: keep the empty option only
      }
    }

    async function submitAdhesion() {
      const status = document.getElementById("adhesionStatus");
      if (status) status.textContent = "";
      const payload = {
        prenom: document.getElementById("memberFirstName")?.value.trim() || "",
        nom: document.getElementById("memberLastName")?.value.trim() || "",
        email: document.getElementById("memberEmail")?.value.trim() || "",
        telephone: document.getElementById("memberPhone")?.value.trim() || "",
        fonction: document.getElementById("memberFunction")?.value.trim() || "",
        organisation: document.getElementById("memberOrganization")?.value.trim() || "",
        pole: document.getElementById("adhesionPole")?.value.trim() || "",
        adhesion_type: memberType ? memberType.value : "",
        password: document.getElementById("memberPassword")?.value || ""
      };
      const confirmPassword = document.getElementById("memberPasswordConfirm")?.value || "";
      if (!payload.prenom || !payload.nom || !payload.email || !payload.telephone || !payload.fonction || !payload.organisation || !payload.pole || !payload.adhesion_type || !payload.password) {
        if (status) status.textContent = "Merci de remplir tous les champs obligatoires.";
        return;
      }
      if (payload.password.length < 6) {
        if (status) status.textContent = "Le mot de passe doit contenir au moins 6 caracteres.";
        return;
      }
      if (payload.password !== confirmPassword) {
        if (status) status.textContent = "Les mots de passe ne correspondent pas.";
        return;
      }
      try {
        const res = await fetch("api.php?route=membership/request", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        const text = await res.text();
        if (!res.ok) throw new Error(text || "Erreur API");
        if (status) status.textContent = "Demande envoyee. Le controleur du pole vous contactera pour l activation.";
        document.getElementById("adhesionForm").reset();
        updatePrice();
      } catch (err) {
        if (status) status.textContent = "Erreur lors de l envoi. Merci de reessayer.";
      }
    }

    if (memberType) {
      memberType.addEventListener("change", updatePrice);
    }
    const btn = document.getElementById("btnSubmitAdhesion");
    if (btn) btn.addEventListener("click", submitAdhesion);
    loadPoles();
    updatePrice();
  </script>
</body>
</html>
